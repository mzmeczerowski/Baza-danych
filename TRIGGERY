USE KlubRozrywki
--||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||--
---Trigger Stan Kasy ---
CREATE TRIGGER stan_Kasy on Zamowienia
AFTER INSERT 
AS
BEGIN
IF (SELECT id_zamowienie FROM inserted) IS NOT NULL
BEGIN
DECLARE @nowe table (ilosc int, id_kasa int, cena money)
insert into @nowe SELECT ins.ilosc, ins.id_kasa, pro.cena_za_porcje
FROM inserted as ins join Produkty as pro on ins.id_produkt = pro.id_produkt

UPDATE Kasa SET stan+=(select ilosc*cena from @nowe)
WHERE id_kasa = (SELECT id_kasa FROM @nowe)
END
END
GO
--|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||--
--------Wyzwalacz aktualizujacy stan magazynu po zakupie --------
CREATE TRIGGER stan_magazynu ON Zamowienia
AFTER INSERT
AS
BEGIN
IF (SELECT id_produkt FROM inserted) IS NOT NULL
BEGIN
DECLARE @Ilosc FLOAT
SET @Ilosc = (SELECT ilosc FROM inserted) * (SELECT gramatura_porcji FROM Produkty P JOIN inserted I ON P.id_produkt=I.id_produkt )/1000
UPDATE Produkty
SET [stan_magazyn(w kg)] = [stan_magazyn(w kg)] - @Ilosc
WHERE id_produkt = (SELECT id_produkt FROM inserted)
PRINT 'Produkt sprzedano poprawnie'
END 
END
GO
SELECT * FROM Produkty
GO
INSERT INTO Zamowienia VALUES(2,NULL,2,2,GETDATE())
SELECT * FROM Produkty
---------------------Wyzwalacz zmieniajacy stan satnowiska po zamowieniu *jesli jest juz zajete nie pozwala na zakup -------------
CREATE TRIGGER zajete ON Zamowienia
AFTER INSERT
AS
BEGIN
IF (SELECT id_stanowisko FROM inserted) IS NOT NULL 
BEGIN
	IF (SELECT S.czy_wolne FROM StanowiskaUslug S join inserted I ON S.id_stanowisko=I.id_stanowisko) = 1
	BEGIN
	UPDATE StanowiskaUslug
	SET czy_wolne = 0
	WHERE id_stanowisko = (SELECT id_stanowisko FROM inserted)
	PRINT 'Stanowisko zostalo zajete'
	END
	ELSE
	PRINT 'Stanowisko jest juz zajete'
END
END

SELECT * FROM Zamowienia
------------------------------------------
---Wyzwalacz przy zwalnianiu pracownika upewnia sie czy jest jakas osoba na to samo stanowisko ------------
CREATE TRIGGER czy_jest_inny_pracownik ON Pracownicy
INSTEAD OF DELETE
AS
BEGIN
DECLARE @stanowisko INT
SET @stanowisko = (SELECT id_stanowisko FROM deleted)
IF EXISTS (SELECT P.id_pracownik FROM Pracownicy P LEFT JOIN deleted D
ON P.id_pracownik = D.id_pracownik WHERE P.id_stanowisko = @stanowisko AND D.id_pracownik IS NULL)
DELETE FROM Pracownicy WHERE id_pracownik = (SELECT id_pracownik FROM deleted)
ELSE
PRINT 'NIE MOZNA USUNAC PRACOWNIKA!!! NIE MAMY NIKOGO NA JEGO MIEJSCE !!!!'
END
 ---------------------------------------------------------------------
 ---
